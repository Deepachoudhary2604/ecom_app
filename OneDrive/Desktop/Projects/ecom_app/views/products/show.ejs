<%- layout('layouts/boilerplate') %>
<%- include('../partials/navbar') %>
<%- include('../partials/flash') %>

<div class="container mt-5 mb-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb" style="background: transparent;">
            <li class="breadcrumb-item"><a href="/products" style="color: #667eea;">Products</a></li>
            <li class="breadcrumb-item active"><%= foundProduct.name %></li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- Product Image & Details -->
        <div class="col-lg-6">
            <div class="card shadow-lg" style="border-radius: 15px; overflow: hidden; border: none;">
                <div style="height: 400px; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); display: flex; align-items: center; justify-content: center;">
                    <img src="<%= foundProduct.img %>" 
                         class="img-fluid" 
                         alt="<%= foundProduct.name %>"
                         style="max-height: 100%; max-width: 100%; object-fit: contain;">
                </div>
                
                <div class="card-body p-5">
                    <h2 class="card-title fw-bold mb-3" style="color: #333; font-size: 2rem;">
                        <%= foundProduct.name %>
                    </h2>

                    <div class="mb-4">
                        <h4 class="card-price text-success fw-bold" style="font-size: 2.5rem;">
                            ‚Çπ<%= foundProduct.price.toLocaleString('en-IN') %>
                        </h4>
                        <small class="text-muted">
                            <i class="bi bi-truck"></i> Free shipping available
                        </small>
                    </div>

                    <p class="card-text" style="color: #666; font-size: 1.1rem; line-height: 1.6;">
                        <%= foundProduct.desc %>
                    </p>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                            <i class="bi bi-bag-plus"></i> Add to Cart
                        </button>
                        <button class="btn btn-light btn-lg" style="border: 2px solid #667eea; color: #667eea; font-weight: 600;">
                            <i class="bi bi-heart"></i> Add to Wishlist
                        </button>
                    </div>

                    <!-- Admin Actions -->
                    <% if(currentUser && currentUser.role === 'admin') { %>
                        <div class="btn-group w-100 mt-4" role="group">
                            <a href="/products/<%=foundProduct._id%>/edit" class="btn btn-warning">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <form action="/products/<%= foundProduct._id %>?_method=DELETE" method="POST" style="width: 50%;">
                                <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure?')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                        <a href="/products/new" class="btn btn-success w-100 mt-2">
                            <i class="bi bi-plus-circle"></i> Add New Product
                        </a>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="col-lg-6">
            <!-- Add Review Card -->
            <div class="card shadow-lg mb-4" style="border-radius: 15px; border: none;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; color: white;">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-chat-left-text"></i> Leave a Review
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form action="/products/<%=foundProduct._id%>/review" method="POST">
                        <div class="mb-3">
                            <label class="form-label fw-bold" for="rating">Rating</label>
                            <div style="font-size: 2rem; margin-bottom: 15px;">
                                <input class="form-range" type="range" min="1" max="5" value="3" name="rating" id="rating" onchange="updateStars(this.value)">
                                <div id="starDisplay" style="margin-top: 10px;">
                                    ‚≠ê‚≠ê‚≠ê <span style="color: #667eea; font-weight: bold;">3 Stars</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold" for="comment">Your Comment</label>
                            <textarea id="comment" 
                                      class="form-control" 
                                      rows="4" 
                                      name="comment"
                                      placeholder="Share your experience with this product..."
                                      style="border: 2px solid #e0e0e0; border-radius: 8px;">
                            </textarea>
                        </div>

                        <button class="btn btn-primary w-100" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; font-weight: 600;">
                            <i class="bi bi-send"></i> Submit Review
                        </button>
                    </form>
                </div>
            </div>

            <!-- Reviews Display -->
            <% if(foundProduct.reviews.length > 0) { %>
                <h5 class="fw-bold mb-3">üìù Customer Reviews (<%= foundProduct.reviews.length %>)</h5>
                <div class="d-flex flex-column gap-3">
                    <% for(let review of foundProduct.reviews){ %>
                        <div class="card shadow-sm" style="border-radius: 12px; border: none;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span style="color: #ffc107; font-size: 1.1rem;">
                                            <%= '‚≠ê'.repeat(review.rating) %>
                                        </span>
                                        <small class="text-muted d-block">
                                            <% if(review.createdAt){ %>
                                                <%= review.createdAt.toDateString() %>
                                            <%}%>
                                        </small>
                                    </div>
                                    <% if(currentUser && currentUser.role === 'admin') { %>
                                        <form action="/products/<%= foundProduct._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                                            <button class="btn btn-danger btn-sm">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    <% } %>
                                </div>
                                <p class="card-text" style="color: #666;">
                                    <%= review.comment %>
                                </p>
                            </div>
                        </div>
                    <% } %>
                </div>
            <% } else { %>
                <div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1, #bee5eb); border: none; color: #0c5460;">
                    <i class="bi bi-info-circle"></i> No reviews yet. Be the first to review!
                </div>
            <% } %>
        </div>
    </div>
</div>

<style>
    .form-range {
        height: 6px;
        border-radius: 3px;
    }

    .form-range::-webkit-slider-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
    }

    .form-range::-moz-range-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
    }

    .btn {
        transition: all 0.3s;
    }

    .btn:hover {
        transform: translateY(-2px);
    }
</style>

<script>
    function updateStars(value) {
        const stars = '‚≠ê'.repeat(value);
        document.getElementById('starDisplay').innerHTML = `${stars} <span style="color: #667eea; font-weight: bold;">${value} ${value == 1 ? 'Star' : 'Stars'}</span>`;
    }
</script>
    